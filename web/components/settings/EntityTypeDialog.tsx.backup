'use client'

import { useState, useEffect } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import { X, ChevronDown, Database, Filter } from 'lucide-react'
import { EntityType, ValueConstraints } from '@/types'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { Switch } from '@/components/ui/switch'
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
  SelectGroup,
  SelectLabel,
} from '@/components/ui/select'
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from '@/components/ui/collapsible'
import { DateTimePicker } from '@/components/ui/datetime-picker'

interface EntityTypeDialogProps {
  open: boolean
  onClose: () => void
  onSubmit: (data: EntityTypeFormData) => void
  entityType?: EntityType | null
  sources?: Array<{ id: string; name: string }>
  articles?: Array<{ id: string; title: string; source_config_id: string }>  // ğŸ†• æ–‡æ¡£åˆ—è¡¨
  isLoading?: boolean
}

export interface EntityTypeFormData {
  type: string
  name: string
  description: string
  weight: number
  similarity_threshold: number
  scope: 'global' | 'source' | 'article'  // ğŸ†• æ·»åŠ  article èŒƒå›´
  source_config_id?: string
  article_id?: string  // ğŸ†• æ–‡æ¡£IDï¼ˆä»… scope=article æ—¶æœ‰å€¼ï¼‰
  // ğŸ†• å€¼ç±»å‹åŒ–é…ç½®å­—æ®µ
  value_format?: string
  value_constraints?: ValueConstraints
}

export function EntityTypeDialog({
  open,
  onClose,
  onSubmit,
  entityType,
  sources = [],
  articles = [],  // ğŸ†• æ–‡æ¡£åˆ—è¡¨
  isLoading = false,
}: EntityTypeDialogProps) {
  const isEditMode = !!entityType

  const [formData, setFormData] = useState<EntityTypeFormData>({
    type: '',
    name: '',
    description: '',
    weight: 1.0,
    similarity_threshold: 0.8,
    scope: 'global',
    source_config_id: undefined,
    article_id: undefined,
    value_format: undefined,
    value_constraints: undefined,
  })
  
  // ğŸ†• ç»Ÿä¸€çš„èŒƒå›´é€‰æ‹©å€¼ï¼ˆç”¨äºæ ‘å½¢ä¸‹æ‹‰æ¡†ï¼‰
  const [scopeValue, setScopeValue] = useState<string>('global')

  const [isValueTypeOpen, setIsValueTypeOpen] = useState(false)

  const [errors, setErrors] = useState<Partial<Record<keyof EntityTypeFormData, string>>>({})

  // é‡ç½®æˆ–å¡«å……è¡¨å•
  useEffect(() => {
    if (open) {
      if (entityType) {
        // å¦‚æœ value_constraints æ˜¯å­—ç¬¦ä¸²ï¼Œéœ€è¦è§£æ
        let parsedConstraints = entityType.value_constraints
        if (typeof entityType.value_constraints === 'string') {
          try {
            parsedConstraints = JSON.parse(entityType.value_constraints)
          } catch (e) {
            console.error('Failed to parse value_constraints:', e)
            parsedConstraints = undefined
          }
        }
        
        const scope = entityType.scope || (entityType.article_id ? 'article' : entityType.source_config_id ? 'source' : 'global')
        
        setFormData({
          type: entityType.type,
          name: entityType.name,
          description: entityType.description || '',
          weight: Number(entityType.weight),
          similarity_threshold: Number(entityType.similarity_threshold),
          scope: scope,
          source_config_id: entityType.source_config_id || undefined,
          article_id: entityType.article_id || undefined,
          value_format: entityType.value_format || undefined,
          value_constraints: parsedConstraints || undefined,
        })
        
        // è®¾ç½®æ ‘å½¢ä¸‹æ‹‰æ¡†çš„å€¼
        if (scope === 'article' && entityType.article_id) {
          setScopeValue(`article:${entityType.article_id}`)
        } else if (scope === 'source' && entityType.source_config_id) {
          setScopeValue(`source:${entityType.source_config_id}`)
        } else {
          setScopeValue('global')
        }
        
        // å¦‚æœæœ‰å€¼ç±»å‹é…ç½®ï¼Œåˆ™å±•å¼€æŠ˜å é¢æ¿
        setIsValueTypeOpen(!!parsedConstraints)
      } else {
        // åˆ›å»ºæ¨¡å¼ï¼šåˆå§‹åŒ–ç©ºè¡¨å•
        setFormData({
          type: '',
          name: '',
          description: '',
          weight: 1.0,
          similarity_threshold: 0.8,
          scope: 'global',
          source_config_id: undefined,
          article_id: undefined,
          value_format: undefined,
          value_constraints: undefined,
        })
        setScopeValue('global')
        setIsValueTypeOpen(false)
      }
      setErrors({})
    } else {
      // ğŸ”¥ å…³é”®ä¿®å¤ï¼šå¼¹æ¡†å…³é—­æ—¶é‡ç½®æ‰€æœ‰çŠ¶æ€
      setFormData({
        type: '',
        name: '',
        description: '',
        weight: 1.0,
        similarity_threshold: 0.8,
        scope: 'global',
        source_config_id: undefined,
        article_id: undefined,
        value_format: undefined,
        value_constraints: undefined,
      })
      setScopeValue('global')
      setIsValueTypeOpen(false)
      setErrors({})
    }
  }, [open, entityType])

  const validateForm = (): boolean => {
    const newErrors: Partial<Record<keyof EntityTypeFormData, string>> = {}

    if (!formData.type.trim()) {
      newErrors.type = 'è¯·è¾“å…¥ç±»å‹æ ‡è¯†ç¬¦'
    } else if (!/^[a-z][a-z0-9_]*$/.test(formData.type)) {
      newErrors.type = 'åªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ï¼Œä¸”å¿…é¡»ä»¥å­—æ¯å¼€å¤´'
    }

    if (!formData.name.trim()) {
      newErrors.name = 'è¯·è¾“å…¥ç±»å‹åç§°'
    }

    if (formData.weight < 0 || formData.weight > 9.99) {
      newErrors.weight = 'æƒé‡èŒƒå›´ï¼š0.0 - 9.99'
    }

    if (formData.similarity_threshold < 0 || formData.similarity_threshold > 1) {
      newErrors.similarity_threshold = 'é˜ˆå€¼èŒƒå›´ï¼š0.0 - 1.0'
    }

    if (formData.scope === 'source' && !formData.source_config_id) {
      newErrors.source_config_id = 'è¯·é€‰æ‹©ä¿¡æ¯æº'
    }

    if (formData.scope === 'article' && !formData.article_id) {
      newErrors.article_id = 'è¯·é€‰æ‹©æ–‡æ¡£'
    }

    // ğŸ†• éªŒè¯å€¼ç±»å‹é…ç½®
    if (formData.value_constraints) {
      // æšä¸¾ç±»å‹å¿…é¡»æœ‰è‡³å°‘ä¸€ä¸ªæšä¸¾å€¼
      if (formData.value_constraints.type === 'enum') {
        if (!formData.value_constraints.enum_values || formData.value_constraints.enum_values.length === 0) {
          newErrors.value_constraints = 'æšä¸¾ç±»å‹è‡³å°‘éœ€è¦ä¸€ä¸ªå¯é€‰å€¼'
        }
      }

      // æ•°å€¼ç±»å‹éªŒè¯èŒƒå›´
      if (['int', 'float'].includes(formData.value_constraints.type)) {
        const min = formData.value_constraints.min
        const max = formData.value_constraints.max
        if (min !== undefined && max !== undefined && min > max) {
          newErrors.value_constraints = 'æœ€å°å€¼ä¸èƒ½å¤§äºæœ€å¤§å€¼'
        }
      }
    }

    setErrors(newErrors)
    return Object.keys(newErrors).length === 0
  }

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault()
    if (validateForm()) {
      onSubmit(formData)
    }
  }

  const handleChange = (field: keyof EntityTypeFormData, value: any) => {
    setFormData((prev) => ({ ...prev, [field]: value }))
    // æ¸…é™¤è¯¥å­—æ®µçš„é”™è¯¯
    if (errors[field]) {
      setErrors((prev) => {
        const newErrors = { ...prev }
        delete newErrors[field]
        return newErrors
      })
    }
  }

  if (!open) return null

  return (
    <AnimatePresence>
      <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
        {/* èƒŒæ™¯é®ç½© */}
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          transition={{ duration: 0.2 }}
          onClick={onClose}
          className="absolute inset-0 bg-black/20 backdrop-blur-md"
        />

        {/* å¯¹è¯æ¡†å†…å®¹ */}
        <motion.div
          initial={{ opacity: 0, scale: 0.95, y: 20 }}
          animate={{ opacity: 1, scale: 1, y: 0 }}
          exit={{ opacity: 0, scale: 0.95, y: 20 }}
          transition={{ type: 'spring', stiffness: 380, damping: 30 }}
          className="relative w-full max-w-2xl bg-white rounded-2xl shadow-2xl max-h-[85vh] overflow-hidden flex flex-col"
        >
          {/* å¤´éƒ¨ */}
          <div className="flex items-center justify-between px-6 py-4 border-b border-gray-200">
            <h2 className="text-lg font-semibold text-gray-800">
              {isEditMode ? 'ç¼–è¾‘æ•°æ®å±æ€§' : 'åˆ›å»ºæ•°æ®å±æ€§'}
            </h2>
            <button
              onClick={onClose}
              className="p-1.5 rounded-lg hover:bg-gray-100 transition-colors"
            >
              <X className="w-5 h-5 text-gray-500" />
            </button>
          </div>

          {/* è¡¨å• */}
          <form onSubmit={handleSubmit} className="overflow-y-auto scrollbar-thin">
            <div className="px-6 py-5 space-y-5">
            {/* åº”ç”¨èŒƒå›´ï¼ˆä»…åˆ›å»ºæ—¶æ˜¾ç¤ºï¼‰ */}
            {!isEditMode && (
              <div className="space-y-3">
                <Label className="text-sm font-medium text-gray-800">
                  åº”ç”¨èŒƒå›´ <span className="text-red-500">*</span>
                </Label>
                <RadioGroup
                  value={formData.scope}
                  onValueChange={(value) => {
                    handleChange('scope', value)
                    if (value === 'global') {
                      handleChange('source_config_id', undefined)
                      handleChange('article_id', undefined)
                    } else if (value === 'source') {
                      handleChange('article_id', undefined)
                    }
                  }}
                  className="space-y-2.5"
                >
                  <label className={`flex items-center gap-3 p-4 border-2 rounded-xl cursor-pointer transition-all ${formData.scope === 'global'
                    ? 'border-gray-700 bg-gray-50 shadow-sm'
                    : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50/50'
                    }`}>
                    <RadioGroupItem value="global" />
                    <div className="flex-1">
                      <div className="text-sm font-semibold text-gray-800">é€šç”¨</div>
                      <div className="text-xs text-gray-500 mt-0.5">æ‰€æœ‰ä¿¡æ¯æºå¯ç”¨</div>
                    </div>
                  </label>
                  <label className={`flex items-center gap-3 p-4 border-2 rounded-xl cursor-pointer transition-all ${formData.scope === 'source'
                    ? 'border-gray-700 bg-gray-50 shadow-sm'
                    : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50/50'
                    }`}>
                    <RadioGroupItem value="source" />
                    <div className="flex-1">
                      <div className="text-sm font-semibold text-gray-800">ä¿¡æ¯æºçº§åˆ«</div>
                      <div className="text-xs text-gray-500 mt-0.5">ä»…æŒ‡å®šä¿¡æ¯æºå¯ç”¨</div>
                    </div>
                  </label>
                  <label className={`flex items-center gap-3 p-4 border-2 rounded-xl cursor-pointer transition-all ${formData.scope === 'article'
                    ? 'border-gray-700 bg-gray-50 shadow-sm'
                    : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50/50'
                    }`}>
                    <RadioGroupItem value="article" />
                    <div className="flex-1">
                      <div className="text-sm font-semibold text-gray-800">æ–‡æ¡£çº§åˆ«</div>
                      <div className="text-xs text-gray-500 mt-0.5">ä»…æŒ‡å®šæ–‡æ¡£å¯ç”¨</div>
                    </div>
                  </label>
                </RadioGroup>
              </div>
            )}

            {/* ä¿¡æ¯æºé€‰æ‹©ï¼ˆæ¡ä»¶æ˜¾ç¤ºï¼‰ */}
            {formData.scope === 'source' && !isEditMode && (
              <div className="space-y-2.5">
                <Label htmlFor="source-select" className="text-sm font-medium text-gray-800">
                  é€‰æ‹©ä¿¡æ¯æº <span className="text-red-500">*</span>
                </Label>
                <Select
                  value={formData.source_config_id || ''}
                  onValueChange={(value) => handleChange('source_config_id', value)}
                >
                  <SelectTrigger
                    id="source-select"
                    className={`w-full h-11 rounded-lg border-2 transition-all ${errors.source_config_id
                      ? 'border-red-300 focus:border-red-500'
                      : 'border-gray-200 hover:border-gray-300 focus:border-gray-500'
                      }`}
                  >
                    <SelectValue placeholder="è¯·é€‰æ‹©ä¿¡æ¯æº" />
                  </SelectTrigger>
                  <SelectContent className="bg-white border-gray-200 shadow-lg z-[100]">
                    {sources.map((source) => (
                      <SelectItem key={source.id} value={source.id} className="cursor-pointer">
                        {source.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
                {errors.source_config_id && (
                  <p className="text-xs text-red-500 mt-1.5 animate-fade-in-down">{errors.source_config_id}</p>
                )}
              </div>
            )}

            {/* ğŸ†• æ–‡æ¡£é€‰æ‹©ï¼ˆæ¡ä»¶æ˜¾ç¤ºï¼‰ */}
            {formData.scope === 'article' && !isEditMode && (
              <div className="space-y-2.5">
                <Label htmlFor="article-select" className="text-sm font-medium text-gray-800">
                  é€‰æ‹©æ–‡æ¡£ <span className="text-red-500">*</span>
                </Label>
                <Select
                  value={formData.article_id || ''}
                  onValueChange={(value) => {
                    handleChange('article_id', value)
                    // è‡ªåŠ¨è®¾ç½®å¯¹åº”çš„ source_config_id
                    const selectedArticle = articles.find(a => a.id === value)
                    if (selectedArticle) {
                      handleChange('source_config_id', selectedArticle.source_config_id)
                    }
                  }}
                >
                  <SelectTrigger
                    id="article-select"
                    className={`w-full h-11 rounded-lg border-2 transition-all ${errors.article_id
                      ? 'border-red-300 focus:border-red-500'
                      : 'border-gray-200 hover:border-gray-300 focus:border-gray-500'
                      }`}
                  >
                    <SelectValue placeholder="è¯·é€‰æ‹©æ–‡æ¡£" />
                  </SelectTrigger>
                  <SelectContent className="bg-white border-gray-200 shadow-lg z-[100] max-h-[300px]">
                    {/* æŒ‰ä¿¡æ¯æºåˆ†ç»„æ˜¾ç¤ºæ–‡æ¡£ */}
                    {sources.map((source) => {
                      const sourceArticles = articles.filter(a => a.source_config_id === source.id)
                      if (sourceArticles.length === 0) return null
                      
                      return (
                        <SelectGroup key={source.id}>
                          <SelectLabel className="flex items-center gap-1.5 px-2 py-1.5 text-xs text-gray-600">
                            <Database className="w-3 h-3" />
                            {source.name}
                          </SelectLabel>
                          
                          {sourceArticles.map(article => (
                            <SelectItem 
                              key={article.id} 
                              value={article.id} 
                              className="cursor-pointer pl-6"
                            >
                              <div className="flex items-center gap-2">
                                <Filter className="w-3 h-3 text-blue-500" />
                                <span className="truncate max-w-[220px]">{article.title}</span>
                              </div>
                            </SelectItem>
                          ))}
                        </SelectGroup>
                      )
                    })}
                  </SelectContent>
                </Select>
                {errors.article_id && (
                  <p className="text-xs text-red-500 mt-1.5 animate-fade-in-down">{errors.article_id}</p>
                )}
              </div>
            )}

            {/* ç±»å‹æ ‡è¯†ç¬¦ */}
            <div className="space-y-2.5">
              <Label htmlFor="type-input" className="text-sm font-medium text-gray-800">
                ç±»å‹æ ‡è¯†ç¬¦ <span className="text-red-500">*</span>
              </Label>
              <Input
                id="type-input"
                type="text"
                value={formData.type}
                onChange={(e) => handleChange('type', e.target.value)}
                disabled={isEditMode}
                placeholder="ä¾‹å¦‚: company, project_stage"
                className={`h-11 rounded-lg border-2 transition-all ${errors.type
                  ? 'border-red-300 focus:border-red-500'
                  : 'border-gray-200 hover:border-gray-300 focus:border-gray-500'
                  } ${isEditMode ? 'bg-gray-50 cursor-not-allowed opacity-60' : ''}`}
              />
              {errors.type && <p className="text-xs text-red-500 mt-1.5 animate-fade-in-down">{errors.type}</p>}
              {isEditMode && (
                <p className="text-xs text-gray-500 mt-1.5">ç±»å‹æ ‡è¯†ç¬¦åˆ›å»ºåä¸å¯ä¿®æ”¹</p>
              )}
            </div>

            {/* ç±»å‹åç§° */}
            <div className="space-y-2.5">
              <Label htmlFor="name-input" className="text-sm font-medium text-gray-800">
                ç±»å‹åç§° <span className="text-red-500">*</span>
              </Label>
              <Input
                id="name-input"
                type="text"
                value={formData.name}
                onChange={(e) => handleChange('name', e.target.value)}
                placeholder="ä¾‹å¦‚: å…¬å¸ã€é¡¹ç›®é˜¶æ®µ"
                className={`h-11 rounded-lg border-2 transition-all ${errors.name
                  ? 'border-red-300 focus:border-red-500'
                  : 'border-gray-200 hover:border-gray-300 focus:border-gray-500'
                  }`}
              />
              {errors.name && <p className="text-xs text-red-500 mt-1.5 animate-fade-in-down">{errors.name}</p>}
            </div>

            {/* æè¿° */}
            <div className="space-y-2.5">
              <Label htmlFor="description-input" className="text-sm font-medium text-gray-800">
                æè¿°
              </Label>
              <Textarea
                id="description-input"
                value={formData.description}
                onChange={(e) => handleChange('description', e.target.value)}
                placeholder="ç”¨äºæŒ‡å¯¼ AI æå–è¯¥ç±»å‹å®ä½“çš„æè¿°"
                rows={3}
                className="resize-none rounded-lg border-2 border-gray-200 hover:border-gray-300 focus:border-gray-500 transition-all"
              />
            </div>

            {/* ğŸ†• å€¼ç±»å‹é…ç½®ï¼ˆå¯æŠ˜å ï¼‰ */}
            <Collapsible open={isValueTypeOpen} onOpenChange={setIsValueTypeOpen}>
              <CollapsibleTrigger className="flex items-center justify-between w-full p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                <div className="flex items-center gap-2">
                  <span className="text-sm font-medium text-gray-800">å€¼ç±»å‹é…ç½®</span>
                  <span className="text-xs text-gray-500">(å¯é€‰)</span>
                </div>
                <ChevronDown
                  className={`w-4 h-4 text-gray-500 transition-transform ${isValueTypeOpen ? 'transform rotate-180' : ''
                    }`}
                />
              </CollapsibleTrigger>

              <CollapsibleContent className="space-y-4 pt-4">
                {/* ğŸ†• å¸¸ç”¨æ¨¡æ¿å¿«æ·é€‰æ‹© */}
                <div className="space-y-2">
                  <Label className="text-sm font-medium text-gray-800">å¿«é€Ÿæ¨¡æ¿</Label>
                  <div className="grid grid-cols-2 gap-2">
                    <button
                      type="button"
                      onClick={() => {
                        handleChange('value_constraints', {
                          type: 'float',
                          min: 0,
                          unit: 'å…ƒ',
                        })
                        handleChange('value_format', '{number}{unit}')
                      }}
                      className="px-3 py-2 text-sm bg-white border-2 border-gray-200 rounded-lg hover:border-gray-400 hover:bg-gray-50 transition-all text-left"
                    >
                      <div className="font-medium text-gray-800">ğŸ’° ä»·æ ¼</div>
                      <div className="text-xs text-gray-500">æµ®ç‚¹æ•° + å•ä½</div>
                    </button>
                    <button
                      type="button"
                      onClick={() => {
                        handleChange('value_constraints', {
                          type: 'enum',
                          enum_values: ['éœ€æ±‚åˆ†æ', 'è®¾è®¡', 'å¼€å‘', 'æµ‹è¯•', 'ä¸Šçº¿'],
                        })
                        handleChange('value_format', undefined)
                      }}
                      className="px-3 py-2 text-sm bg-white border-2 border-gray-200 rounded-lg hover:border-gray-400 hover:bg-gray-50 transition-all text-left"
                    >
                      <div className="font-medium text-gray-800">ğŸ“‹ é¡¹ç›®é˜¶æ®µ</div>
                      <div className="text-xs text-gray-500">æšä¸¾ç±»å‹</div>
                    </button>
                    <button
                      type="button"
                      onClick={() => {
                        handleChange('value_constraints', {
                          type: 'datetime',
                        })
                        handleChange('value_format', undefined)
                      }}
                      className="px-3 py-2 text-sm bg-white border-2 border-gray-200 rounded-lg hover:border-gray-400 hover:bg-gray-50 transition-all text-left"
                    >
                      <div className="font-medium text-gray-800">ğŸ“… æ—¥æœŸ</div>
                      <div className="text-xs text-gray-500">æ—¥æœŸæ—¶é—´ç±»å‹</div>
                    </button>
                    <button
                      type="button"
                      onClick={() => {
                        handleChange('value_constraints', {
                          type: 'enum',
                          enum_values: ['å¾…å¤„ç†', 'è¿›è¡Œä¸­', 'å·²å®Œæˆ', 'å·²å–æ¶ˆ'],
                        })
                        handleChange('value_format', undefined)
                      }}
                      className="px-3 py-2 text-sm bg-white border-2 border-gray-200 rounded-lg hover:border-gray-400 hover:bg-gray-50 transition-all text-left"
                    >
                      <div className="font-medium text-gray-800">âœ… çŠ¶æ€</div>
                      <div className="text-xs text-gray-500">æšä¸¾ç±»å‹</div>
                    </button>
                  </div>
                </div>

                {/* å€¼ç±»å‹é€‰æ‹© */}
                <div className="space-y-2.5">
                  <Label htmlFor="value-type-select" className="text-sm font-medium text-gray-800">
                    å€¼ç±»å‹
                  </Label>
                  <Select
                    value={formData.value_constraints?.type || 'none'}
                    onValueChange={(value) => {
                      if (value === 'none') {
                        handleChange('value_constraints', undefined)
                        handleChange('value_format', undefined)
                      } else {
                        handleChange('value_constraints', {
                          type: value as ValueConstraints['type'],
                        })
                      }
                    }}
                  >
                    <SelectTrigger
                      id="value-type-select"
                      className="w-full h-11 rounded-lg border-2 border-gray-200 hover:border-gray-300 focus:border-gray-500 transition-all"
                    >
                      <SelectValue placeholder="é€‰æ‹©å€¼ç±»å‹ï¼ˆç•™ç©ºåˆ™è‡ªåŠ¨è§£æï¼‰" />
                    </SelectTrigger>
                    <SelectContent className="bg-white border-gray-200 shadow-lg">
                      <SelectItem value="none">ä¸æŒ‡å®šï¼ˆè‡ªåŠ¨è§£æï¼‰</SelectItem>
                      <SelectItem value="text">æ–‡æœ¬</SelectItem>
                      <SelectItem value="int">æ•´æ•°</SelectItem>
                      <SelectItem value="float">æµ®ç‚¹æ•°</SelectItem>
                      <SelectItem value="datetime">æ—¥æœŸæ—¶é—´</SelectItem>
                      <SelectItem value="bool">å¸ƒå°”å€¼</SelectItem>
                      <SelectItem value="enum">æšä¸¾</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                {/* æšä¸¾å€¼è¾“å…¥ï¼ˆä»…æšä¸¾ç±»å‹æ˜¾ç¤ºï¼‰ */}
                {formData.value_constraints?.type === 'enum' && (
                  <div className="space-y-2.5">
                    <Label className="text-sm font-medium text-gray-800">
                      æšä¸¾å¯é€‰å€¼ <span className="text-red-500">*</span>
                    </Label>
                    <div className="space-y-2">
                      <div className="flex flex-wrap gap-2">
                        {formData.value_constraints.enum_values?.map((value, index) => (
                          <span
                            key={index}
                            className="inline-flex items-center gap-1 px-3 py-1 bg-gray-100 text-gray-700 rounded-md text-sm"
                          >
                            {value}
                            <button
                              type="button"
                              onClick={() => {
                                const newEnumValues = [...(formData.value_constraints?.enum_values || [])]
                                newEnumValues.splice(index, 1)
                                handleChange('value_constraints', {
                                  ...formData.value_constraints,
                                  enum_values: newEnumValues.length > 0 ? newEnumValues : undefined,
                                })
                              }}
                              className="ml-1 text-gray-400 hover:text-gray-600"
                            >
                              <X className="w-3 h-3" />
                            </button>
                          </span>
                        ))}
                      </div>
                      <div className="flex gap-2">
                        <Input
                          type="text"
                          placeholder="è¾“å…¥æšä¸¾å€¼åæŒ‰å›è½¦æ·»åŠ "
                          className="h-9 rounded-lg border-2 border-gray-200 hover:border-gray-300 focus:border-gray-500 transition-all"
                          onKeyDown={(e) => {
                            if (e.key === 'Enter') {
                              e.preventDefault()
                              const input = e.currentTarget
                              const value = input.value.trim()
                              if (value) {
                                const currentEnumValues = formData.value_constraints?.enum_values || []
                                if (!currentEnumValues.includes(value)) {
                                  handleChange('value_constraints', {
                                    ...formData.value_constraints,
                                    type: 'enum',
                                    enum_values: [...currentEnumValues, value],
                                  })
                                  input.value = ''
                                }
                              }
                            }
                          }}
                        />
                      </div>
                    </div>
                    {errors.value_constraints && (
                      <p className="text-xs text-red-500 mt-1.5 animate-fade-in-down">
                        {errors.value_constraints}
                      </p>
                    )}
                  </div>
                )}

                {/* ğŸš§ æ•°å€¼èŒƒå›´å’Œå•ä½è¾“å…¥æ¡†ï¼ˆæš‚æ—¶éšè—ï¼Œå¾…åç«¯å®ç°èŒƒå›´æ ¡éªŒåå¯ç”¨ï¼‰
                    TODO: åç«¯å®ç° min/max èŒƒå›´æ ¡éªŒåï¼Œå–æ¶ˆæ³¨é‡Šä»¥ä¸‹ä»£ç  */}
                {['int', 'float'].includes(formData.value_constraints?.type || '') && (
                  <>
                    {/* <div className="grid grid-cols-2 gap-4">
                      <div className="space-y-2.5">
                        <Label htmlFor="min-value-input" className="text-sm font-medium text-gray-800">
                          æœ€å°å€¼
                        </Label>
                        <Input
                          id="min-value-input"
                          type="number"
                          value={formData.value_constraints?.min ?? ''}
                          onChange={(e) => {
                            const value = e.target.value === '' ? undefined : parseFloat(e.target.value)
                            handleChange('value_constraints', {
                              ...formData.value_constraints!,
                              min: value,
                            })
                          }}
                          placeholder="ä¸é™"
                          step={formData.value_constraints?.type === 'float' ? '0.01' : '1'}
                          className="h-9 rounded-lg border-2 border-gray-200 hover:border-gray-300 focus:border-gray-500 transition-all"
                        />
                      </div>
                      <div className="space-y-2.5">
                        <Label htmlFor="max-value-input" className="text-sm font-medium text-gray-800">
                          æœ€å¤§å€¼
                        </Label>
                        <Input
                          id="max-value-input"
                          type="number"
                          value={formData.value_constraints?.max ?? ''}
                          onChange={(e) => {
                            const value = e.target.value === '' ? undefined : parseFloat(e.target.value)
                            handleChange('value_constraints', {
                              ...formData.value_constraints!,
                              max: value,
                            })
                          }}
                          placeholder="ä¸é™"
                          step={formData.value_constraints?.type === 'float' ? '0.01' : '1'}
                          className="h-9 rounded-lg border-2 border-gray-200 hover:border-gray-300 focus:border-gray-500 transition-all"
                        />
                      </div>
                    </div> */}

                    <div className="space-y-2.5">
                      <Label htmlFor="unit-input" className="text-sm font-medium text-gray-800">
                        å•ä½
                      </Label>
                      <Input
                        id="unit-input"
                        type="text"
                        value={formData.value_constraints?.unit || ''}
                        onChange={(e) => {
                          const value = e.target.value.trim()
                          handleChange('value_constraints', {
                            ...formData.value_constraints!,
                            unit: value || undefined,
                          })
                        }}
                        placeholder="ä¾‹å¦‚: å…ƒã€ç¾å…ƒã€kg"
                        className="h-9 rounded-lg border-2 border-gray-200 hover:border-gray-300 focus:border-gray-500 transition-all"
                      />
                    </div>

                    {errors.value_constraints && (
                      <p className="text-xs text-red-500 mt-1.5 animate-fade-in-down">
                        {errors.value_constraints}
                      </p>
                    )}
                  </>
                )}

                {/* ğŸ†• é»˜è®¤å€¼é…ç½® - æ ¹æ®å€¼ç±»å‹è”åŠ¨ */}
                {formData.value_constraints?.type && (
                  <div className="space-y-3 p-4 border-2 border-gray-200 rounded-lg bg-gray-50">
                    <Label className="text-sm font-medium text-gray-800">é»˜è®¤å€¼</Label>
                    
                    {/* æšä¸¾ç±»å‹ */}
                    {formData.value_constraints.type === 'enum' && formData.value_constraints.enum_values && (
                      <div>
                        <Select
                          value={formData.value_constraints.default || '__none__'}
                          onValueChange={(value) => {
                            handleChange('value_constraints', {
                              ...formData.value_constraints!,
                              default: value === '__none__' ? undefined : value
                            })
                          }}
                        >
                          <SelectTrigger className="h-10 bg-white">
                            <SelectValue placeholder="é€‰æ‹©é»˜è®¤å€¼ï¼ˆå¯é€‰ï¼‰" />
                          </SelectTrigger>
                          <SelectContent className="z-[100]">
                            <SelectItem value="__none__">ä¸è®¾ç½®</SelectItem>
                            {formData.value_constraints.enum_values.map(val => (
                              <SelectItem key={val} value={val}>{val}</SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                      </div>
                    )}
                    
                    {/* æ—¶é—´ç±»å‹ */}
                    {formData.value_constraints.type === 'datetime' && (
                      <div>
                        <DateTimePicker
                          value={formData.value_constraints.default ? new Date(formData.value_constraints.default) : undefined}
                          onChange={(date) => {
                            handleChange('value_constraints', {
                              ...formData.value_constraints!,
                              default: date ? date.toISOString() : undefined
                            })
                          }}
                        />
                      </div>
                    )}

                    {/* æ–‡æœ¬ç±»å‹ */}
                    {formData.value_constraints.type === 'text' && (
                      <div>
                        <Input
                          value={formData.value_constraints.default || ''}
                          onChange={(e) => {
                            handleChange('value_constraints', {
                              ...formData.value_constraints!,
                              default: e.target.value || undefined
                            })
                          }}
                          placeholder="è¾“å…¥é»˜è®¤æ–‡æœ¬"
                          className="h-10 bg-white"
                        />
                      </div>
                    )}

                    {/* æ•´æ•°ç±»å‹ */}
                    {formData.value_constraints.type === 'int' && (
                      <div>
                        <Input
                          type="number"
                          step="1"
                          value={formData.value_constraints.default || ''}
                          onChange={(e) => {
                            handleChange('value_constraints', {
                              ...formData.value_constraints!,
                              default: e.target.value || undefined
                            })
                          }}
                          placeholder="è¾“å…¥é»˜è®¤æ•´æ•°"
                          className="h-10 bg-white"
                        />
                      </div>
                    )}

                    {/* æµ®ç‚¹æ•°ç±»å‹ */}
                    {formData.value_constraints.type === 'float' && (
                      <div>
                        <Input
                          type="number"
                          step="0.01"
                          value={formData.value_constraints.default || ''}
                          onChange={(e) => {
                            handleChange('value_constraints', {
                              ...formData.value_constraints!,
                              default: e.target.value || undefined
                            })
                          }}
                          placeholder="è¾“å…¥é»˜è®¤æµ®ç‚¹æ•°"
                          className="h-10 bg-white"
                        />
                      </div>
                    )}
                    
                    {/* å¸ƒå°”ç±»å‹ */}
                    {formData.value_constraints.type === 'bool' && (
                      <div>
                        <Select
                          value={formData.value_constraints.default || '__none__'}
                          onValueChange={(value) => {
                            handleChange('value_constraints', {
                              ...formData.value_constraints!,
                              default: value === '__none__' ? undefined : value
                            })
                          }}
                        >
                          <SelectTrigger className="h-10 bg-white">
                            <SelectValue placeholder="é€‰æ‹©é»˜è®¤å€¼ï¼ˆå¯é€‰ï¼‰" />
                          </SelectTrigger>
                          <SelectContent className="z-[100]">
                            <SelectItem value="__none__">ä¸è®¾ç½®</SelectItem>
                            <SelectItem value="true">æ˜¯</SelectItem>
                            <SelectItem value="false">å¦</SelectItem>
                          </SelectContent>
                        </Select>
                      </div>
                    )}
                    
                    {/* ğŸ†• å¼ºåˆ¶æ¨¡å¼å¼€å…³ - ä»…å½“æœ‰é»˜è®¤å€¼æ—¶æ˜¾ç¤º */}
                    {formData.value_constraints.default && (
                      <div className="flex items-center justify-between pt-2 border-t border-gray-200">
                        <div className="flex-1 pr-4">
                          <Label className="text-sm font-medium text-gray-800">å¼ºåˆ¶æ¨¡å¼</Label>
                          <p className="text-xs text-gray-500 mt-0.5">
                            è¦†ç›–æå–ç»“æœï¼Œå§‹ç»ˆä½¿ç”¨é»˜è®¤å€¼
                          </p>
                        </div>
                        <Switch
                          checked={formData.value_constraints.override || false}
                          onCheckedChange={(checked) => {
                            handleChange('value_constraints', {
                              ...formData.value_constraints!,
                              override: checked
                            })
                          }}
                        />
                      </div>
                    )}
                  </div>
                )}

                {/* å€¼æ ¼å¼æ¨¡æ¿ */}
                {/* {formData.value_constraints?.type && (
                  <div className="space-y-2.5">
                    <Label htmlFor="value-format-input" className="text-sm font-medium text-gray-800">
                      å€¼æ ¼å¼æ¨¡æ¿
                    </Label>
                    <Input
                      id="value-format-input"
                      type="text"
                      value={formData.value_format || ''}
                      onChange={(e) => handleChange('value_format', e.target.value.trim() || undefined)}
                      placeholder="ä¾‹å¦‚: {number}{unit} æˆ– {value}"
                      className="h-9 rounded-lg border-2 border-gray-200 hover:border-gray-300 focus:border-gray-500 transition-all"
                    />
                    <p className="text-xs text-gray-500">
                      å¯ä½¿ç”¨å ä½ç¬¦: {'{'}value{'}'}, {'{'}number{'}'}, {'{'}unit{'}'}
                    </p>
                  </div>
                )} */}
              </CollapsibleContent>
            </Collapsible>

            {/* æƒé‡å’Œé˜ˆå€¼ */}
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2.5">
                <Label htmlFor="weight-input" className="text-sm font-medium text-gray-800">
                  æƒé‡ <span className="text-red-500">*</span>
                </Label>
                <Input
                  id="weight-input"
                  type="number"
                  value={formData.weight}
                  onChange={(e) => handleChange('weight', parseFloat(e.target.value) || 0)}
                  step="0.1"
                  min="0"
                  max="9.99"
                  className={`h-11 rounded-lg border-2 transition-all ${errors.weight
                    ? 'border-red-300 focus:border-red-500'
                    : 'border-gray-200 hover:border-gray-300 focus:border-gray-500'
                    }`}
                />
                {errors.weight && <p className="text-xs text-red-500 mt-1.5 animate-fade-in-down">{errors.weight}</p>}
              </div>

              <div className="space-y-2.5">
                <Label htmlFor="threshold-input" className="text-sm font-medium text-gray-800">
                  ç›¸ä¼¼åº¦é˜ˆå€¼ <span className="text-red-500">*</span>
                </Label>
                <Input
                  id="threshold-input"
                  type="number"
                  value={formData.similarity_threshold}
                  onChange={(e) =>
                    handleChange('similarity_threshold', parseFloat(e.target.value) || 0)
                  }
                  step="0.01"
                  min="0"
                  max="1"
                  className={`h-11 rounded-lg border-2 transition-all ${errors.similarity_threshold
                    ? 'border-red-300 focus:border-red-500'
                    : 'border-gray-200 hover:border-gray-300 focus:border-gray-500'
                    }`}
                />
                {errors.similarity_threshold && (
                  <p className="text-xs text-red-500 mt-1.5 animate-fade-in-down">{errors.similarity_threshold}</p>
                )}
              </div>
            </div>

            {/* æŒ‰é’® */}
            <div className="flex gap-3 pt-3">
              <motion.button
                type="button"
                onClick={onClose}
                whileHover={{ scale: 1.01 }}
                whileTap={{ scale: 0.99 }}
                className="flex-1 h-11 px-4 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-xl hover:bg-gray-50 active:bg-gray-100 transition-all"
              >
                å–æ¶ˆ
              </motion.button>
              <motion.button
                type="submit"
                disabled={isLoading}
                whileHover={{ scale: isLoading ? 1 : 1.01 }}
                whileTap={{ scale: isLoading ? 1 : 0.99 }}
                className="flex-1 h-11 px-4 text-sm font-medium text-white bg-gray-700 rounded-xl hover:bg-gray-800 active:bg-gray-900 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm hover:shadow transition-all"
              >
                {isLoading ? 'æäº¤ä¸­...' : isEditMode ? 'æ›´æ–°' : 'åˆ›å»º'}
              </motion.button>
            </div>
            </div>
          </form>
        </motion.div>
      </div>
    </AnimatePresence>
  )
}
