# version: '3.8'

services:
  # Database service
  mysql:
    image: mysql:8.0
    container_name: sag_mysql
    environment:
      MYSQL_ROOT_PASSWORD: sag_root
      MYSQL_DATABASE: ${MYSQL_DATABASE:-sag}
      MYSQL_USER: sag
      MYSQL_PASSWORD: sag_pass
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    command: >
      --default-authentication-plugin=mysql_native_password
      --max-allowed-packet=64M
      --innodb-buffer-pool-size=512M
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - sag_network

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: sag_elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    healthcheck:
      test:
        ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - sag_network

  # Backend API service
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: sag_api
    # Use host network to access LLM server on localhost:8011 (like in warhammer_40000_graph_rag)
    network_mode: host
    environment:
      # Database configuration (connect to Docker services via host network)
      # MySQL is accessible via Docker bridge IP or use service discovery
      - MYSQL_HOST=127.0.0.1
      - MYSQL_PORT=${MYSQL_PORT:-3306}
      - MYSQL_USER=${MYSQL_USER:-sag}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-sag}

      # Elasticsearch configuration (connect via host network)
      - ES_HOST=127.0.0.1
      - ES_PORT=${ES_PORT:-9200}

      # LLM configuration
      # With network_mode: host, we can access localhost:8011 directly (like in warhammer_40000_graph_rag)
      - LLM_MODEL=${LLM_MODEL:-sophnet/Qwen3-30B-A3B-Thinking-2507}
      - LLM_BASE_URL=${LLM_BASE_URL:-http://127.0.0.1:8011/v1}
      - LLM_API_KEY=${LLM_API_KEY}

      # Embedding configuration
      - EMBEDDING_MODEL_NAME=${EMBEDDING_MODEL_NAME:-Qwen/Qwen3-Embedding-0.6B}
      - EMBEDDING_BASE_URL=${EMBEDDING_BASE_URL:-http://127.0.0.1:8009/v1}
      - EMBEDDING_API_KEY=${EMBEDDING_API_KEY}

      # System configuration
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - API_WORKERS=${API_WORKERS:-4} # Production environment default 4 workers
    # Note: With network_mode: host, expose/ports are not needed
    volumes:
      - ./uploads:/app/uploads
      - ./migrations:/app/migrations
      - ./alembic.ini:/app/alembic.ini
    # ğŸ†• Add startup command, migrate database first then initialize (production environment)
    command: >
      sh -c "
        echo 'ğŸ”§ Starting initialization...' &&
        echo 'â³ Waiting for database to be ready...' &&
        sleep 5 &&
        echo 'ğŸ”„ Executing database migration (Alembic)...' &&
        uv run alembic upgrade head &&
        echo 'âœ… Database migration completed' &&
        echo 'ğŸ“Š Inserting default entity types...' &&
        uv run python scripts/init_database.py &&
        echo 'ğŸ” Initializing Elasticsearch...' &&
        uv run python scripts/init_elasticsearch.py &&
        echo 'ğŸŒ Starting API service (Workers: $${API_WORKERS:-4})...' &&
        uv run python -m sag.api.main
      "
    # Note: With network_mode: host, depends_on and networks are not compatible
    # MySQL and Elasticsearch are accessed via 127.0.0.1 with their exposed ports
    restart: unless-stopped

  # Frontend Web service
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: sag_web
    expose:
      - "3000"
    ports:
      - "3001:3000"
    depends_on:
      - api
    networks:
      - sag_network
    restart: unless-stopped

  # Nginx reverse proxy (HTTP Only)
  nginx:
    image: nginx:alpine
    container_name: sag_nginx
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "8080:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - web
      # Note: API uses network_mode: host, so it's not in Docker network
      # Nginx accesses it via host.docker.internal:8000
    networks:
      - sag_network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  mysql_data:
    driver: local
  es_data:
    driver: local

networks:
  sag_network:
    driver: bridge
