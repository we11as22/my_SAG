# version: '3.8'

services:
  # æ•°æ®åº“æœåŠ¡
  mysql:
    image: mysql:8.0
    container_name: sag_mysql
    environment:
      MYSQL_ROOT_PASSWORD: sag_root
      MYSQL_DATABASE: ${MYSQL_DATABASE:-sag}
      MYSQL_USER: sag
      MYSQL_PASSWORD: sag_pass
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    command: >
      --default-authentication-plugin=mysql_native_password
      --max-allowed-packet=64M
      --innodb-buffer-pool-size=512M
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - sag_network

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: sag_elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    healthcheck:
      test:
        ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - sag_network

  # åç«¯ API æœåŠ¡
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: sag_api
    environment:
      # æ•°æ®åº“é…ç½®ï¼ˆè¿æ¥å®¿ä¸»æœºæœåŠ¡ï¼‰
      - MYSQL_HOST=mysql
      - MYSQL_PORT=${MYSQL_PORT:-3306}
      - MYSQL_USER=${MYSQL_USER:-sag}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-sag}

      # Elasticsearch é…ç½®ï¼ˆè¿æ¥å®¿ä¸»æœºæœåŠ¡ï¼‰
      - ES_HOST=elasticsearch
      - ES_PORT=${ES_PORT:-9200}

      # LLM é…ç½®
      - LLM_MODEL=${LLM_MODEL:-sophnet/Qwen3-30B-A3B-Thinking-2507}
      - LLM_BASE_URL=${LLM_BASE_URL}
      - LLM_API_KEY=${LLM_API_KEY}

      # Embedding é…ç½®
      - EMBEDDING_MODEL_NAME=${EMBEDDING_MODEL_NAME:-Qwen/Qwen3-Embedding-0.6B}
      - EMBEDDING_BASE_URL=${EMBEDDING_BASE_URL}
      - EMBEDDING_API_KEY=${EMBEDDING_API_KEY}

      # ç³»ç»Ÿé…ç½®
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - API_WORKERS=${API_WORKERS:-4} # æœåŠ¡å™¨ç”Ÿäº§ç¯å¢ƒé»˜è®¤ 4 workers
    expose:
      - "8000:8000"
    volumes:
      - ./uploads:/app/uploads
      - ./migrations:/app/migrations
      - ./alembic.ini:/app/alembic.ini
    # ğŸ†• æ·»åŠ å¯åŠ¨å‘½ä»¤ï¼Œå…ˆè¿ç§»æ•°æ®åº“å†åˆå§‹åŒ–ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
    command: >
      sh -c "
        echo 'ğŸ”§ å¼€å§‹åˆå§‹åŒ–...' &&
        echo 'â³ ç­‰å¾…æ•°æ®åº“å°±ç»ª...' &&
        sleep 5 &&
        echo 'ğŸ”„ æ‰§è¡Œæ•°æ®åº“è¿ç§» (Alembic)...' &&
        uv run alembic upgrade head &&
        echo 'âœ… æ•°æ®åº“è¿ç§»å®Œæˆ' &&
        echo 'ğŸ“Š æ’å…¥é»˜è®¤å®ä½“ç±»å‹...' &&
        uv run python scripts/init_database.py &&
        echo 'ğŸ” åˆå§‹åŒ– Elasticsearch...' &&
        uv run python scripts/init_elasticsearch.py &&
        echo 'ğŸŒ å¯åŠ¨ API æœåŠ¡ (Workers: $${API_WORKERS:-4})...' &&
        uv run python -m sag.api.main
      "
    depends_on:
      mysql:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    networks:
      - sag_network
    restart: unless-stopped

  # å‰ç«¯ Web æœåŠ¡
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: sag_web
    expose:
      - "3000"
    depends_on:
      - api
    networks:
      - sag_network
    restart: unless-stopped

  # Nginx åå‘ä»£ç†ï¼ˆHTTP Onlyï¼‰
  nginx:
    image: nginx:alpine
    container_name: sag_nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - web
      - api
    networks:
      - sag_network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  mysql_data:
    driver: local
  es_data:
    driver: local

networks:
  sag_network:
    driver: bridge
