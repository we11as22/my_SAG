# Docker Compose - API Only Mode
# åªå¯åŠ¨ API æœåŠ¡ï¼Œè¿æ¥å®¿ä¸»æœºçš„æ•°æ®åº“ç­‰æœåŠ¡
# ä½¿ç”¨æ–¹å¼ï¼šdocker compose -f docker-compose.api.yml up -d
# æ³¨æ„ï¼šæ•°æ®åº“è¿ç§»ç”±ä¸»æœåŠ¡ç®¡ç†ï¼Œæ­¤é…ç½®ä¸æ‰§è¡Œè¿ç§»

services:
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: sag_api
    environment:
      # æ•°æ®åº“é…ç½®ï¼ˆè¿æ¥å®¿ä¸»æœºæœåŠ¡ï¼‰
      - MYSQL_HOST=host.docker.internal
      - MYSQL_PORT=${MYSQL_PORT:-3306}
      - MYSQL_USER=${MYSQL_USER:-sag}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-sag}
      
      # Elasticsearch é…ç½®ï¼ˆè¿æ¥å®¿ä¸»æœºæœåŠ¡ï¼‰
      - ES_HOST=host.docker.internal
      - ES_PORT=${ES_PORT:-9200}
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
      
      # LLM é…ç½®
      - LLM_MODEL=${LLM_MODEL:-sophnet/Qwen3-30B-A3B-Thinking-2507}
      - LLM_BASE_URL=${LLM_BASE_URL}
      - LLM_API_KEY=${LLM_API_KEY}
      
      # Embedding é…ç½®
      - EMBEDDING_MODEL_NAME=${EMBEDDING_MODEL_NAME:-Qwen/Qwen3-Embedding-0.6B}
      - EMBEDDING_BASE_URL=${EMBEDDING_BASE_URL}
      - EMBEDDING_API_KEY=${EMBEDDING_API_KEY}
      
      # ç³»ç»Ÿé…ç½®
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - API_WORKERS=${API_WORKERS:-1}
    ports:
      - "8600:8000"  # API ç«¯å£æ˜ å°„
    volumes:
      - ./uploads:/app/uploads
    # æ˜ å°„ host.docker.internal åˆ°å®¿ä¸»æœºç½‘å…³
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # æ‰§è¡Œåˆå§‹åŒ–å¹¶å¯åŠ¨ API
    command: >
      sh -c "
        echo 'ğŸ”§ å¼€å§‹åˆå§‹åŒ–...' &&
        echo 'ğŸ“Š åˆå§‹åŒ–æ•°æ®åº“...' &&
        uv run python scripts/init_database.py &&
        echo 'ğŸ” åˆå§‹åŒ– Elasticsearch...' &&
        uv run python scripts/init_elasticsearch.py &&
        echo 'ğŸŒ å¯åŠ¨ API æœåŠ¡...' &&
        echo 'ğŸ“š API Docs: http://localhost:8600/api/docs' &&
        uv run python -m sag.api.main
      "
    restart: unless-stopped

